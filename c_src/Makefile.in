CC = @CC@
OBJ_DIR = ../priv/obj
LIB_DIR = ../priv/lib
TARGET = $(shell uname)

ERLANG_CFLAGS = @ERLANG_CFLAGS@
ERLANG_LIBS = @ERLANG_LIBS@

ifeq ($(TARGET),Darwin)
	CFLAGS=$(ERLANG_CFLAGS) -c -Wall -O2 -no-cpp-precomp -DUSE_THREADS -D_THREAD_SAFE -D_REENTRANT -fPIC -fno-common
	LDFLAGS=-L/usr/lib -lcrypto -bundle -flat_namespace -undefined suppress
else
	CFLAGS=$(ERLANG_CFLAGS) -Wall -fpic -shared
	LDFLAGS=$(ERLANG_LIBS) -lcrypto
endif

all: $(LIB_DIR) $(LIB_DIR)/netspire_crypto_drv.so

$(LIB_DIR):
	test -d $(OBJ_DIR) || mkdir -p $(OBJ_DIR)
	test -d $(LIB_DIR) || mkdir -p $(LIB_DIR)

$(LIB_DIR)/netspire_crypto_drv.so: netspire_crypto_drv.c
ifeq ($(TARGET), Darwin)
	$(CC) $(CFLAGS) -o $(OBJ_DIR)/netspire_crypto_drv.o netspire_crypto_drv.c
	$(CC) $(LDFLAGS) -o $(LIB_DIR)/netspire_crypto_drv.so $(OBJ_DIR)/netspire_crypto_drv.o
else
	$(CC) $(LDFLAGS) $(CFLAGS) -o $(LIB_DIR)/netspire_crypto_drv.so netspire_crypto_drv.c
endif

clean:
	rm -f $(OBJ_DIR)/*.o
	rm -f $(LIB_DIR)/*.so

distclean: clean
	rm -f Makefile
