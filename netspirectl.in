#!/bin/sh

NODE=netspire
HOST=$(hostname -f)

ERL=%%ERL%%
# Starts the Erlang runtime system with SMP support (enable|auto|disable)
SMP=auto
# Path to store internal application state
NETSPIRE_DB=%%SPOOLDIR%%
# Path to "ebin" directory of your Netspire installation
NETSPIRE_EBIN=%%BEAMDIR%%
# Path to netspire.conf file
NETSPIRE_CONFIG=%%NETSPIRE_CONFIG%%
# Path to netspire logs
NETSPIRE_LOG=%%NETSPIRE_LOG%%

ERL_CRASH_DUMP=$NETSPIRE_LOG/erl_crash.dump
export ERL_CRASH_DUMP

start() {
    echo "Starting Netspire"
    for dir in $NETSPIRE_DB $NETSPIRE_EBIN; do
        [ ! -d $dir ] && echo "$dir does not exists" && exit 1
    done
    [ ! -f $NETSPIRE_CONFIG ] &&
        echo "Configuration file does not exists" && exit 1
    %%ERL%% +W w \
        -noinput -detached \
        -smp $SMP \
        -name $NODE@$HOST \
        -pa $NETSPIRE_EBIN \
        -mnesia dir "\"$NETSPIRE_DB\"" \
        -netspire config \"$NETSPIRE_CONFIG\" \
        -eval 'application:start(netspire).'
}

stop() {
    echo "Stopping Netspire"
    %%ERL%% -name nsctl@$HOST \
        -eval "rpc:call('$NODE@$HOST', init, stop, [], 5000)" \
        -s erlang halt \
        -noshell \
        -noinput \
        -nohidden
}

shell() {
    $ERL -name netspire-remote -hidden -remsh $NODE@$HOST
}

usage()
{
    echo "usage: $0 {start|stop|shell}"
    exit 1
}

[ $# -lt 1 ] && usage

case $1 in
    start)
        start;;
    stop)
        stop;;
    shell)
        shell;;
    *) usage;;
esac
