ERLANG_CFLAGS= @ERLANG_CFLAGS@
ERLANG_LIBS = @ERLANG_LIBS@

SUBDIRS = src/radius src src/crypto src/modules src/netflow c_src

DESTDIR = @prefix@

BEAMDIR = $(DESTDIR)/ebin
SPOOLDIR = $(DESTDIR)/db
PRIVDIR = $(DESTDIR)/priv
SODIR = $(PRIVDIR)/lib
BINDIR = $(DESTDIR)/bin
CONFDIR = $(DESTDIR)/etc
LOGDIR = $(DESTDIR)/log
ETCDIR = $(DESTDIR)/etc

all: checks all-recursive
	test -r netspire.app && cp netspire.app ebin

checks:
	test -d ebin || mkdir ebin

all-recursive clean-recursive distclean-recursive:
	@subdirs="$(SUBDIRS)"; for subdir in $$subdirs; do \
	target=`echo $@|sed 's,-recursive,,'`; \
	echo making $$target in $$subdir; \
	(cd $$subdir && $(MAKE) $$target) || exit 1; \
	done

install: all
	install -d $(BEAMDIR)
	install -m 644 ebin/*.beam $(BEAMDIR)
	install -m 644 netspire.app $(BEAMDIR)
	install -d -m 750 $(SPOOLDIR)
	install -d $(SODIR)
	install -d $(BINDIR)
	install -m 644 priv/lib/*.so $(SODIR)
	install -d $(PRIVDIR)
	install -d $(PRIVDIR)/radius
	install -m 644 priv/radius/* $(PRIVDIR)/radius
	install -d -m 750 $(ETCDIR)
	install -m 644 *.conf.sample $(ETCDIR)
	install -d -m 750 $(LOGDIR)
	sed < netspirectl.in > netspirectl \
		-e 's!%%SPOOLDIR%%!$(SPOOLDIR)!g' \
		-e 's!%%BEAMDIR%%!$(BEAMDIR)!g' \
		-e 's!%%ERL%%!@ERL@!g' \
		-e 's!%%NETSPIRE_CONFIG%%!$(ETCDIR)/netspire.conf!g'
	install -m 755 netspirectl $(BINDIR)

run: all
	@ERL@ -pa ebin -mnesia dir \"/tmp/netspire\" -netspire config \"netspire.conf\" \
		-sname netspire -eval 'application:start(netspire).'

clean: clean-recursive
	rm -f erl_crash.dump
	rm -f netspirectl
	find . -name "*~" -exec rm -f {} \;

distclean: clean clean-recursive distclean-recursive
	rm -f config.status
	rm -f config.log
	rm -f Makefile
	rm -f configure
	rm -f erl_crash.dump
	rm -rf ebin autom4te.cache
